---
title: "Basic Regressions"
author: "Tom"
date: "September 1, 2020"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

#options(width = 300)

# packages 
library(tidyverse)
library(readstata13)
library(sjPlot)
library(shiny)
library(miceadds)

# object with outcome variables 
yvars <- c("student_knowledge",
           "ecd_student_knowledge",
           "inputs",
           "infrastructure",
           "intrinsic_motivation",
            "content_knowledge",
           "operational_manage",
           "instr_leader",
           "principal_knowl_score",
           "principal_manage",
           "bi",
           "national_learning_goals",
           "mandates_accountability",
           "quality_bureaucracy",
           "impartial_decision_making")

#load data 
md <- read.dta13(file = "C:/Users/WB551206/OneDrive - WBG/Documents/Dashboard/global-edu-dashboard/baseline/DataSets/final/merge_district_tdist.dta",
                 convert.factors = TRUE) %>%
  select(idschool, countryname, country, g1, g2, yvars)


```

# Changes From Last Time

I succeeded in adding a whopping 14 schools by recovering missing GPS data. This 14 number is conservative, but could increase by a few schools depending on how liberal we want to be in our geo-guessing.

# Model Specifications
- Country Fixed Effects (where each country is an indicator; Peru is the excluded/compared country)
- Standard Errors are clustered on District

## Main findings 
1. With the data we have,we see that the overall Bureaucracy Index it not a good predictor of any school outcomes, except for maybe school infrastructure. <br>
2. Signifant relationships among the secondary indicators are sparse, but what few there are are promising: <br>
  - National Learning Goals predict 2 variables related to instruction. <br>
  - Mandates and Accountability has a mild relationship with Student Knowledge <br>
  - Quality of Bureaucracy predicts infrastructure <br>
  - Impartial Decision-Making predicts 3 school-level indicators

```{r models,  include=FALSE}
# run + store all regressions regressions as objects

# explanatory = bi 
lm.bi.1 <- lm.cluster(data = md, 
   student_knowledge ~ bi + as.factor(countryname), cluster = md$g2)
lm.bi.2 <- lm.cluster(data = md, 
   ecd_student_knowledge ~ bi + as.factor(countryname), cluster = "g2")
lm.bi.3 <- lm.cluster(data = md, 
   inputs ~ bi + as.factor(countryname), cluster = "g2")
lm.bi.4 <- lm.cluster(data = md, 
   infrastructure ~ bi + as.factor(countryname), cluster = "g2")
lm.bi.5 <- lm.cluster(data = md, 
   intrinsic_motivation ~ bi + as.factor(countryname), cluster = "g2")
lm.bi.6 <- lm.cluster(data = md, 
   content_knowledge ~ bi + as.factor(countryname), cluster = "g2")
lm.bi.8 <- lm.cluster(data = md, 
   operational_manage ~ bi + as.factor(countryname), cluster = "g2")
lm.bi.9 <- lm.cluster(data = md, 
   instr_leader ~ bi + as.factor(countryname), cluster = "g2")
lm.bi.10 <- lm.cluster(data = md, 
   principal_knowl_score ~ bi + as.factor(countryname), cluster = "g2")
lm.bi.11 <- lm.cluster(data = md, 
   principal_manage ~ bi + as.factor(countryname), cluster = "g2")

# explanatory = nlg 
lm.nlg.1 <- lm.cluster(data = md, 
   student_knowledge ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.2 <- lm.cluster(data = md, 
   ecd_student_knowledge ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.3 <- lm.cluster(data = md, 
   inputs ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.4 <- lm.cluster(data = md, 
   infrastructure ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.5 <- lm.cluster(data = md, 
   intrinsic_motivation ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.6 <- lm.cluster(data = md, 
   content_knowledge ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.8 <- lm.cluster(data = md, 
   operational_manage ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.9 <- lm.cluster(data = md, 
   instr_leader ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.10 <- lm.cluster(data = md, 
   principal_knowl_score ~ national_learning_goals + as.factor(countryname), cluster = "g2")
lm.nlg.11 <- lm.cluster(data = md, 
   principal_manage ~ national_learning_goals + as.factor(countryname), cluster = "g2")

# explanatory = ma
lm.ma.1 <- lm.cluster(data = md, 
   student_knowledge ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.2 <- lm.cluster(data = md, 
   ecd_student_knowledge ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.3 <- lm.cluster(data = md, 
   inputs ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.4 <- lm.cluster(data = md, 
   infrastructure ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.5 <- lm.cluster(data = md, 
   intrinsic_motivation ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.6 <- lm.cluster(data = md, 
   content_knowledge ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.8 <- lm.cluster(data = md, 
   operational_manage ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.9 <- lm.cluster(data = md, 
   instr_leader ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.10 <- lm.cluster(data = md, 
   principal_knowl_score ~ mandates_accountability + as.factor(countryname), cluster = "g2")
lm.ma.11 <- lm.cluster(data = md, 
   principal_manage ~ mandates_accountability + as.factor(countryname), cluster = "g2")


# explanatory = qb
lm.qb.1 <- lm.cluster(data = md, 
   student_knowledge ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.2 <- lm.cluster(data = md, 
   ecd_student_knowledge ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.3 <- lm.cluster(data = md, 
   inputs ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.4 <- lm.cluster(data = md, 
   infrastructure ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.5 <- lm.cluster(data = md, 
   intrinsic_motivation ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.6 <- lm.cluster(data = md, 
   content_knowledge ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.8 <- lm.cluster(data = md, 
   operational_manage ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.9 <- lm.cluster(data = md, 
   instr_leader ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.10 <- lm.cluster(data = md, 
   principal_knowl_score ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")
lm.qb.11 <- lm.cluster(data = md, 
   principal_manage ~ quality_bureaucracy + as.factor(countryname), cluster = "g2")

# explanatory = idm
lm.idm.1 <- lm.cluster(data = md, 
   student_knowledge ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.2 <- lm.cluster(data = md, 
   ecd_student_knowledge ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.3 <- lm.cluster(data = md, 
   inputs ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.4 <- lm.cluster(data = md, 
   infrastructure ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.5 <- lm.cluster(data = md, 
   intrinsic_motivation ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.6 <- lm.cluster(data = md, 
   content_knowledge ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.8 <- lm.cluster(data = md, 
   operational_manage ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.9 <- lm.cluster(data = md, 
   instr_leader ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.10 <- lm.cluster(data = md, 
   principal_knowl_score ~ impartial_decision_making + as.factor(countryname), cluster = "g2")
lm.idm.11 <- lm.cluster(data = md, 
   principal_manage ~ impartial_decision_making + as.factor(countryname), cluster = "g2")

```

## Regression Tables

```{r bi}
# table 1
tab_model(lm.bi.1$lm_res, lm.bi.2$lm_res, lm.bi.3$lm_res, lm.bi.4$lm_res, lm.bi.5$lm_res, lm.bi.6$lm_res,
          lm.bi.8$lm_res, lm.bi.9$lm_res, lm.bi.10$lm_res,lm.bi.11$lm_res,
          pred.labels = c("Bureaucracy Index"),
          title = "Bureaucracy Index",
          show.ci = FALSE,
          show.se = TRUE,
          collapse.se = TRUE,
          linebreak = TRUE,
          show.intercept = FALSE,
          p.style = "stars",
          terms = c("bi"))

```

```{r nlg}
# table 1
tab_model(lm.nlg.1$lm_res, lm.nlg.2$lm_res, lm.nlg.3$lm_res, lm.nlg.4$lm_res, lm.nlg.5$lm_res, lm.nlg.6$lm_res,
          lm.nlg.8$lm_res, lm.nlg.9$lm_res, lm.nlg.10$lm_res,lm.nlg.11$lm_res,
          pred.labels = c("National Learning Goals"),
          title = "National Learning Goals",
          show.ci = FALSE,
          show.se = TRUE,
          collapse.se = TRUE,
          linebreak = TRUE,
          show.intercept = FALSE,
          p.style = "stars",
          terms = c("national_learning_goals"))

```

```{r ma}
# table 1
tab_model(lm.ma.1$lm_res, lm.ma.2$lm_res, lm.ma.3$lm_res, lm.ma.4$lm_res, lm.ma.5$lm_res, lm.ma.6$lm_res,
          lm.ma.8$lm_res, lm.ma.9$lm_res, lm.ma.10$lm_res,lm.ma.11$lm_res,
          pred.labels = c("Mandates + Acct'y"),
          title = "Mandates and Accountability",
          show.ci = FALSE,
          show.se = TRUE,
          collapse.se = TRUE,
          linebreak = TRUE,
          show.intercept = FALSE,
          p.style = "stars",
          terms = c("mandates_accountability"))

```


```{r qb}
# table 1
tab_model(lm.qb.1$lm_res, lm.qb.2$lm_res, lm.qb.3$lm_res, lm.qb.4$lm_res, lm.qb.5$lm_res, lm.qb.6$lm_res,
          lm.qb.8$lm_res, lm.qb.9$lm_res, lm.qb.10$lm_res,lm.qb.11$lm_res,
          pred.labels = c("Qual. of Bureaucracy"),
          title = "Quality of Bureaucracy",
          show.ci = FALSE,
          show.se = TRUE,
          collapse.se = TRUE,
          linebreak = TRUE,
          show.intercept = FALSE,
          p.style = "stars",
          terms = c("quality_bureaucracy"))

```


```{r idm}
# table 1
tab_model(lm.idm.1$lm_res, lm.idm.2$lm_res, lm.idm.3$lm_res, lm.idm.4$lm_res, lm.idm.5$lm_res, lm.idm.6$lm_res,
          lm.idm.8$lm_res, lm.idm.9$lm_res, lm.idm.10$lm_res,lm.idm.11$lm_res,
          pred.labels = c("Impar. Dec'n-Making"),
          title = "Impartial Decision-Making",
          show.ci = FALSE,
          show.se = TRUE,
          collapse.se = TRUE,
          linebreak = TRUE,
          show.intercept = FALSE,
          p.style = "stars",
          terms = c("impartial_decision_making"))

```


```{r}
summary(lm.bi.1)
summary(lm.bi.2)
summary(lm.bi.3)
```


### Interactive By-Country Visualizations
Select up to two pairs of explanatory variables (Bureaucracy Indicators) and Outcomes Variables (School Outcomes) to visualize the scatterplots and best-fit lines by country.

####Variable Selector
Plot 1
```{r}


# inputs 1
selectInput("yvar1", #inputid
            "Outcome Variable 1", #label
           choices = c("Student Knowledge" = "student_knowledge",
           "1st Grade Student Knowledge" = "ecd_student_knowledge",
           "Inputs" = "inputs",
           "Infrastructure" = "infrastructure",
           "Teacher Motivation" = "intrinsic_motivation",
           "Teacher Content Knowledge" = "content_knowledge",
           "Operational Management" = "operational_manage",
           "Instructional Leadership" = "instr_leadership",
           "Principal Knolwedge Score" = "principal_knowl_score",
           "Principal Management" = "principal_manage"),
           multiple = FALSE,
           selected = "infrastructure"
)
           
selectInput("xvar1", #inputid
            "Explanatory Variable 1", #label
           choices = c("Bureaucracy Index" = "bi",
                       "National Learning Goals" = "national_learning_goals",
                       "Mandates and Accountability" = "mandates_accountability",
                       "Quality of Bureaucracy" = "quality_bureaucracy",
                       "Impartial Decision-Making" = "impartial_decision_making"),
           multiple = FALSE,
           selected = "bi"
)
```



Plot 2
```{r}
# inputs 2
selectInput("yvar2", #inputid
            "Outcome Variable 2", #label
           choices = c("Student Knowledge" = "student_knowledge",
           "1st Grade Student Knowledge" = "ecd_student_knowledge",
           "Inputs" = "inputs",
           "Infrastructure" = "infrastructure",
           "Teacher Motivation" = "intrinsic_motivation",
           "Teacher Content Knowledge" = "content_knowledge",
           "Operational Management" = "operational_manage",
           "Instructional Leadership" = "instr_leadership",
           "Principal Knolwedge Score" = "principal_knowl_score",
           "Principal Management" = "principal_manage"),
           multiple = FALSE,
           selected = "content_knowledge"
)
           
selectInput("xvar2", #inputid
            "Explanatory Variable 2", #label
           choices = c("Bureaucracy Index" = "bi",
                       "National Learning Goals" = "national_learning_goals",
                       "Mandates and Accountability" = "mandates_accountability",
                       "Quality of Bureaucracy" = "quality_bureaucracy",
                       "Impartial Decision-Making" = "impartial_decision_making"),
           multiple = FALSE,
           selected = "national_learning_goals"
)



```


Plot 1
```{r, fig.align='center', fig.show='hold'}

# plot 1
renderPlot({
  # make the plot 
 ggplot(md, aes_string(input$xvar1, input$yvar1)) +
    geom_jitter() +
    geom_smooth(method = lm) +
    facet_wrap(~ countryname)
  
},
# plot options
  width  = 500,
  height = 400,
  res = 100
)


```

Plot 2

```{r}



# plot 2         
renderPlot({
  # make the plot 
 ggplot(md, aes_string(input$xvar2, input$yvar2)) +
    geom_jitter() +
    geom_smooth(method = lm) +
    facet_wrap(~ countryname)
  
},
# plot options
  width  = 500,
  height = 400,
  res = 100
)



```
 